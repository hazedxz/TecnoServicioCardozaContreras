<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V-Exclusive</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #fa0050; --bg: #000000; --card: #121212; --text: #ffffff; --gray: #888; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; }

        /* SIDEBAR (Escritorio) */
        aside { width: 260px; padding: 30px; border-right: 1px solid #222; display: flex; flex-direction: column; }
        .logo { font-size: 2rem; font-weight: 800; color: white; margin-bottom: 40px; letter-spacing: -1px; }
        .logo span { color: var(--primary); }
        .menu-item { display: flex; align-items: center; gap: 15px; padding: 15px; color: var(--gray); cursor: pointer; transition: 0.3s; border-radius: 15px; margin-bottom: 5px; font-weight: 600; }
        .menu-item:hover, .menu-item.active { color: white; background: #1a1a1a; }
        .menu-item.active i { color: var(--primary); }
        
        /* AREA PRINCIPAL */
        main { flex: 1; position: relative; overflow-y: auto; scrollbar-width: none; }
        .feed-header { padding: 20px; border-bottom: 1px solid #222; position: sticky; top: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 10; display: flex; justify-content: space-between; align-items: center; }
        
        /* BOTÓN FLOTANTE (NUEVO DISEÑO MAS COMODO) */
        .fab-btn {
            position: fixed; bottom: 30px; right: 30px;
            background: var(--primary); color: white;
            width: 60px; height: 60px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; box-shadow: 0 10px 30px rgba(250, 0, 80, 0.4);
            cursor: pointer; transition: 0.3s; z-index: 100; border: none;
        }
        .fab-btn:hover { transform: scale(1.1); }

        /* POSTS */
        .feed-container { max-width: 500px; margin: 0 auto; padding-top: 20px; padding-bottom: 100px; }
        .post { background: var(--card); border-radius: 20px; border: 1px solid #222; margin-bottom: 20px; overflow: hidden; }
        .post-header { padding: 15px; display: flex; align-items: center; justify-content: space-between; }
        .user-info { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #333; }
        .username { font-weight: 700; font-size: 0.95rem; display: flex; align-items: center; gap: 4px; }
        
        /* VERIFICADO (SOLO ICONO) */
        .badge-verified { color: #3897f0; font-size: 14px; } /* Azul estilo Twitter/Insta */
        
        .post-img-box { position: relative; width: 100%; background: #000; }
        .post-img { width: 100%; display: block; max-height: 600px; object-fit: cover; }
        
        .post-actions { padding: 15px; display: flex; gap: 20px; }
        .action-btn { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 8px; }
        .action-btn.liked { color: var(--primary); }
        .action-btn span { font-size: 1rem; font-weight: 600; }

        /* PERFIL */
        .profile-view { display: none; }
        .cover-img { width: 100%; height: 200px; object-fit: cover; opacity: 0.7; }
        .profile-details { margin-top: -50px; padding: 0 20px; position: relative; text-align: left; }
        .profile-avatar { width: 100px; height: 100px; border-radius: 50%; border: 4px solid black; object-fit: cover; background: #222; }
        .profile-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; padding: 20px; max-width: 600px; margin: 0 auto; }
        .grid-img { width: 100%; aspect-ratio: 1/1; object-fit: cover; cursor: pointer; border-radius: 4px; background: #222; }

        /* COMPRA / LOCK */
        .locked-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(15px); display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .unlock-btn { background: white; color: black; border: none; padding: 10px 20px; border-radius: 30px; font-weight: 800; cursor: pointer; margin-top: 10px; }

        /* MODALES */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 200; display: none; align-items: center; justify-content: center; }
        .modal-content { background: #111; padding: 30px; border-radius: 20px; width: 90%; max-width: 400px; border: 1px solid #333; }
        .input-field { width: 100%; padding: 12px; background: #000; border: 1px solid #333; color: white; border-radius: 10px; margin: 10px 0; }
        .primary-btn { width: 100%; background: var(--primary); border: none; padding: 15px; border-radius: 12px; color: white; font-weight: bold; cursor: pointer; margin-top: 10px; }

        /* MOBILE NAV */
        .mobile-nav { display: none; position: fixed; bottom: 0; width: 100%; background: black; border-top: 1px solid #222; padding: 15px; justify-content: space-around; z-index: 90; }
        @media (max-width: 768px) { aside { display: none; } .mobile-nav { display: flex; } .fab-btn { bottom: 80px; } }
    </style>
</head>
<body>

    <aside>
        <div class="logo">V<span>EX</span></div>
        <div class="menu-item active" onclick="loadFeed()">
            <i class="fas fa-home"></i> Inicio
        </div>
        <div class="menu-item" onclick="loadMyProfile()">
            <i class="fas fa-user"></i> Mi Perfil
        </div>
        <div class="menu-item" onclick="document.getElementById('walletModal').style.display='flex'">
            <i class="fas fa-wallet"></i> Billetera
        </div>
        <button onclick="auth.signOut()" style="margin-top:auto; background:transparent; border:none; color:#666; cursor:pointer; text-align:left;">Cerrar Sesión</button>
    </aside>

    <main id="main-scroll">
        
        <div id="feed-view">
            <div class="feed-header">
                <h3>Inicio</h3>
            </div>
            <div class="feed-container" id="feed-container">
                </div>
        </div>

        <div id="profile-view" class="profile-view">
            <img id="p-cover" class="cover-img" src="">
            <div class="profile-details">
                <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                    <img id="p-avatar" class="profile-avatar" src="">
                    <button id="btn-edit-profile" onclick="openBioModal()" style="background:#222; color:white; border:1px solid #444; padding:8px 15px; border-radius:20px; cursor:pointer; font-size:12px; display:none;">Editar Perfil</button>
                </div>
                <h2 style="margin-top:10px; display:flex; align-items:center; gap:5px;">
                    <span id="p-name">@usuario</span>
                    <i id="p-badge" class="fas fa-check-circle badge-verified" style="display:none;"></i>
                </h2>
                <p id="p-bio" style="color:#aaa; margin-top:5px; font-size:0.9rem;">Sin biografía.</p>
                
                <hr style="border:0; border-top:1px solid #222; margin: 20px 0;">
                <h4 style="margin-bottom:15px;">PUBLICACIONES</h4>
                <div class="profile-grid" id="profile-posts-grid">
                    </div>
            </div>
        </div>

    </main>

    <button class="fab-btn" onclick="document.getElementById('uploadModal').style.display='flex'">
        <i class="fas fa-plus"></i>
    </button>

    <nav class="mobile-nav">
        <i class="fas fa-home" style="font-size:1.5rem; color:white;" onclick="loadFeed()"></i>
        <i class="fas fa-search" style="font-size:1.5rem; color:#666;"></i>
        <i class="fas fa-user" style="font-size:1.5rem; color:#666;" onclick="loadMyProfile()"></i>
    </nav>

    <div class="modal" id="uploadModal">
        <div class="modal-content">
            <h3>Nueva Publicación</h3>
            <input type="file" id="fileInput" class="input-field">
            <input type="number" id="postPrice" class="input-field" placeholder="Precio (Dejar en 0 para gratis)">
            <button onclick="uploadPost()" class="primary-btn">PUBLICAR AHORA</button>
            <button onclick="document.getElementById('uploadModal').style.display='none'" style="width:100%; background:transparent; border:none; color:#666; margin-top:10px; cursor:pointer;">Cancelar</button>
        </div>
    </div>

    <div class="modal" id="bioModal">
        <div class="modal-content">
            <h3>Editar Perfil</h3>
            <p style="font-size:12px; color:#666;">Toca las imágenes en tu perfil para cambiarlas.</p>
            <textarea id="bioInput" class="input-field" rows="3" placeholder="Tu biografía..."></textarea>
            <button onclick="saveBio()" class="primary-btn">Guardar</button>
            <button onclick="document.getElementById('bioModal').style.display='none'" style="width:100%; background:transparent; border:none; color:#666; margin-top:10px; cursor:pointer;">Cancelar</button>
        </div>
    </div>

    <div class="modal" id="walletModal">
        <div class="modal-content" style="text-align:center;">
            <h1>$<span id="wallet-balance">0.00</span></h1>
            <p style="color:#666; margin-bottom:20px;">Saldo Disponible</p>
            <input type="number" id="rechargeAmount" class="input-field" placeholder="Monto a recargar">
            <button onclick="addMoney()" class="primary-btn">RECARGAR</button>
            <button onclick="document.getElementById('walletModal').style.display='none'" style="width:100%; background:transparent; border:none; color:#666; margin-top:10px; cursor:pointer;">Cerrar</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, arrayUnion, arrayRemove, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { 
             apiKey: "AIzaSyA-y05rnK5lD_v3G7YPS2wE1LlmAjrTz9c",
            authDomain: "v-exclusive.firebaseapp.com",
            projectId: "v-exclusive",
            storageBucket: "v-exclusive.firebasestorage.app",
            messagingSenderId: "312654319716",
            appId: "1:312654319716:web:eca438a0a4f0f9050f0f71"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let myData = null;

        // AUTH
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const snap = await getDoc(doc(db, "usuarios", user.uid));
                myData = { id: user.uid, ...snap.data() };
                loadFeed(); // Cargar feed al inicio
            } else {
                window.location.href = "index.html";
            }
        });

        // FUNCIONES GLOBALES
        window.loadFeed = () => {
            document.getElementById('feed-view').style.display = 'block';
            document.getElementById('profile-view').style.display = 'none';
            document.getElementById('main-scroll').scrollTop = 0;

            const q = query(collection(db, "posts"), orderBy("fecha", "desc"));
            onSnapshot(q, (snap) => {
                const container = document.getElementById('feed-container');
                container.innerHTML = "";
                
                snap.forEach(d => {
                    const post = d.data();
                    const postId = d.id;
                    const isLiked = post.likes?.includes(myData.id);
                    const isOwner = post.creadorId === myData.id;
                    const isLocked = post.precio > 0 && !isOwner && !post.compradores?.includes(myData.id);

                    // Verificar antigüedad (24h)
                    if(new Date().getTime() > post.expiraEn) { deleteDoc(doc(db, "posts", postId)); return; }

                    container.innerHTML += `
                    <div class="post">
                        <div class="post-header">
                            <div class="user-info" onclick="openUserProfile('${post.creadorId}')">
                                <img src="${post.creadorFoto || 'https://via.placeholder.com/40'}" class="avatar">
                                <div class="username">
                                    @${post.creador} 
                                    ${post.verificado ? '<i class="fas fa-check-circle badge-verified"></i>' : ''}
                                </div>
                            </div>
                            ${isOwner ? `<i class="fas fa-trash" onclick="deletePost('${postId}')" style="color:#444; cursor:pointer;"></i>` : ''}
                        </div>

                        <div class="post-img-box">
                            ${isLocked ? `
                                <div class="locked-overlay">
                                    <i class="fas fa-lock" style="font-size:30px; color:var(--primary); margin-bottom:10px;"></i>
                                    <button class="unlock-btn" onclick="buyPost('${postId}', ${post.precio})">
                                        DESBLOQUEAR $${post.precio}
                                    </button>
                                </div>
                                <img src="${post.url}" class="post-img" style="filter:blur(20px);">
                            ` : `
                                <img src="${post.url}" class="post-img">
                            `}
                        </div>

                        <div class="post-actions">
                            <button class="action-btn ${isLiked ? 'liked' : ''}" onclick="toggleLike('${postId}', ${isLiked})">
                                <i class="${isLiked ? 'fas' : 'far'} fa-heart"></i>
                                <span>${post.likes ? post.likes.length : 0}</span>
                            </button>
                        </div>
                    </div>`;
                });
            });
        };

        // CARGAR PERFIL DE ALGUIEN (O EL MIO)
        window.openUserProfile = async (userId) => {
            document.getElementById('feed-view').style.display = 'none';
            document.getElementById('profile-view').style.display = 'block';
            document.getElementById('main-scroll').scrollTop = 0;

            // Obtener datos del usuario
            const userSnap = await getDoc(doc(db, "usuarios", userId));
            const user = userSnap.data();

            // Llenar UI del perfil
            document.getElementById('p-name').innerText = "@" + user.username;
            document.getElementById('p-bio').innerText = user.biografia || "Sin biografía.";
            document.getElementById('p-cover').src = user.fotoPortada || "https://via.placeholder.com/500x200";
            document.getElementById('p-avatar').src = user.fotoPerfil || "https://via.placeholder.com/100";
            
            // Lógica del Badge Verificado
            const badge = document.getElementById('p-badge');
            if (user.verificado) badge.style.display = "inline-block";
            else badge.style.display = "none";

            // Botón editar (solo si es mi perfil)
            const isMe = (myData.id === userId);
            document.getElementById('btn-edit-profile').style.display = isMe ? 'block' : 'none';
            
            // Habilitar subida de fotos de perfil solo si soy yo
            if(isMe) {
                document.getElementById('p-avatar').onclick = () => changePhoto('fotoPerfil');
                document.getElementById('p-cover').onclick = () => changePhoto('fotoPortada');
            } else {
                document.getElementById('p-avatar').onclick = null;
                document.getElementById('p-cover').onclick = null;
            }

            // CARGAR POSTS DE ESTE USUARIO
            const grid = document.getElementById('profile-posts-grid');
            grid.innerHTML = "";
            const q = query(collection(db, "posts"), where("creadorId", "==", userId), orderBy("fecha", "desc"));
            
            onSnapshot(q, (snap) => {
                grid.innerHTML = "";
                snap.forEach(d => {
                    const post = d.data();
                    // En perfil mostramos miniatura, si es de pago y no comprado, se ve borroso
                    const isLocked = post.precio > 0 && !post.compradores?.includes(myData.id) && !isMe;
                    
                    grid.innerHTML += `
                        <div style="position:relative; overflow:hidden; aspect-ratio:1/1;">
                             ${isLocked ? '<div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.5); z-index:2;"><i class="fas fa-lock"></i></div>' : ''}
                             <img src="${post.url}" class="grid-img" style="${isLocked ? 'filter:blur(5px)' : ''}">
                        </div>
                    `;
                });
            });
        };

        window.loadMyProfile = () => openUserProfile(myData.id);

        // LIKES
        window.toggleLike = async (postId, isLiked) => {
            const ref = doc(db, "posts", postId);
            if (isLiked) {
                await updateDoc(ref, { likes: arrayRemove(myData.id) });
            } else {
                await updateDoc(ref, { likes: arrayUnion(myData.id) });
            }
        };

        // SUBIR POST (Corrección: agrega "verificado" al post si el usuario lo es)
        window.uploadPost = async () => {
            const file = document.getElementById('fileInput').files[0];
            const price = parseFloat(document.getElementById('postPrice').value) || 0;
            if(!file) return alert("Selecciona una imagen");

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async () => {
                const ahora = new Date().getTime();
                await addDoc(collection(db, "posts"), {
                    creador: myData.username,
                    creadorId: myData.id,
                    creadorFoto: myData.fotoPerfil || null,
                    verificado: myData.verificado || false, // IMPORTANTE: Guarda si es verificado
                    url: reader.result,
                    precio: price,
                    fecha: ahora,
                    expiraEn: ahora + (24 * 60 * 60 * 1000),
                    likes: [],
                    compradores: []
                });
                document.getElementById('uploadModal').style.display = 'none';
                loadFeed();
            };
        };

        // RESTO DE FUNCIONES (Billetera, Bio, Fotos, Borrar, Comprar)
        window.deletePost = async (id) => { if(confirm("¿Borrar?")) deleteDoc(doc(db, "posts", id)); };
        
        window.buyPost = async (postId, price) => {
            if((myData.saldo || 0) < price) return alert("Saldo insuficiente");
            if(!confirm(`¿Pagar $${price}?`)) return;
            
            // Restar saldo al comprador
            await updateDoc(doc(db, "usuarios", myData.id), { saldo: (myData.saldo || 0) - price });
            // Agregar a compradores del post
            await updateDoc(doc(db, "posts", postId), { compradores: arrayUnion(myData.id) });
            
            // Buscar al creador y darle el dinero
            const postRef = await getDoc(doc(db, "posts", postId));
            const creatorId = postRef.data().creadorId;
            const creatorSnap = await getDoc(doc(db, "usuarios", creatorId));
            const currentBalance = creatorSnap.data().saldo || 0;
            await updateDoc(doc(db, "usuarios", creatorId), { saldo: currentBalance + price });
            
            alert("Compra exitosa");
            location.reload(); 
        };

        window.addMoney = async () => {
            const amount = parseFloat(document.getElementById('rechargeAmount').value);
            if(!amount) return;
            await updateDoc(doc(db, "usuarios", myData.id), { saldo: (myData.saldo || 0) + amount });
            document.getElementById('wallet-balance').innerText = ((myData.saldo || 0) + amount).toFixed(2);
            document.getElementById('walletModal').style.display='none';
        };

        window.saveBio = async () => {
            await updateDoc(doc(db, "usuarios", myData.id), { biografia: document.getElementById('bioInput').value });
            document.getElementById('p-bio').innerText = document.getElementById('bioInput').value;
            document.getElementById('bioModal').style.display='none';
        };

        window.openBioModal = () => {
            document.getElementById('bioInput').value = document.getElementById('p-bio').innerText;
            document.getElementById('bioModal').style.display='flex';
        };

        window.changePhoto = (field) => {
            const input = document.createElement('input'); input.type = 'file'; input.accept = 'image/*';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = async () => {
                    const obj = {}; obj[field] = reader.result;
                    await updateDoc(doc(db, "usuarios", myData.id), obj);
                    loadMyProfile(); // Recargar perfil visualmente
                };
            };
            input.click();
        };

        // Inicializar billetera visualmente
        window.openWallet = () => {
            document.getElementById('wallet-balance').innerText = (myData.saldo || 0).toFixed(2);
            document.getElementById('walletModal').style.display='flex';
        }
    </script>
</body>
</html>